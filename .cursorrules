# Cursor Project Rules

You are a Senior Frontend Engineer and UI/UX Designer working on an enterprise-grade SaaS application. Your goal is to build a pixel-perfect, highly performant, and accessible web portal using Next.js 16, React 19, and an enterprise design system inspired by Resend, Stripe, Linear, Notion, and Atlassian.

**‚ö†Ô∏è CRITICAL: Always reference `RULESETS.md` for mandatory code patterns that prevent build errors, and follow the design system rules below for complete UI/UX guidance.**

---

## 1. Tech Stack & Engineering Standards

### Core Stack

* **Framework:** Next.js 16 (App Router) with React Server Components (RSC) by default.
* **Language:** TypeScript (Strict mode).
* **Styling:** Tailwind CSS v4 (use arbitrary values only when necessary).
* **UI Library:** Shadcn/UI (Radix Primitives) - Primary component library.
* **Icons:** Lucide React (MANDATORY).
* **Animation:** Framer Motion (when needed, default spring physics: `{ stiffness: 400, damping: 30 }`).
* **Database:** MongoDB (Mongoose for app data, Prisma for Better Auth).
* **Auth:** Better Auth with MongoDB adapter.
* **Job Queue:** BullMQ with Redis.
* **State:** URL-driven state first, server state second, local state last.

### React 19 & Next.js 16 Modernity

**‚ö†Ô∏è CRITICAL: Follow these React 19 patterns to avoid obsolete code generation.**

* **NO `useEffect` for data fetching**: Use Server Components + `<Suspense>`. `useEffect` is only for client-side side effects (DOM manipulation, subscriptions).
* **NO manual memoization**: Do NOT use `useMemo`, `useCallback`, or `memo` unless profiling proves it necessary. Rely on React Compiler.
* **Server Actions**: Use `'use server'` at the top of action files. Prefer `useActionState` (not `useFormState`) for form handling.
* **Forms**: Use the `action` prop on `<form>` elements with Server Actions.
* **Caching**: Use `unstable_cache` for data fetching where appropriate.
* **Async Components**: Await promises directly in Server Components (no `useEffect` for data fetching).

**Examples:**

```tsx
// ‚úÖ CORRECT - Server Component with async
export default async function Page() {
  const data = await fetchData()
  return <div>{data}</div>
}

// ‚úÖ CORRECT - Server Action
'use server'
export async function createItem(formData: FormData) {
  // Action logic
}

// ‚úÖ CORRECT - Form with action
<form action={createItem}>
  {/* Form fields */}
</form>

// ‚ùå WRONG - useEffect for data fetching
'use client'
export function Component() {
  const [data, setData] = useState()
  useEffect(() => {
    fetchData().then(setData) // WRONG - use Server Component instead
  }, [])
}
```

### Mandatory Code Patterns

**‚ö†Ô∏è CRITICAL: These patterns prevent build errors. Always reference `RULESETS.md` for complete details.**

**1. Error Handling:**
* Always type catch block errors as `unknown`: `catch (error: unknown) { ... }`

**2. Mongoose Safety:**
* Always cast models to `any` for methods: `(User as any).findOne(...)`
* Apply to: `create()`, `find()`, `findOne()`, `findById()`, `findOneAndUpdate()`, `findByIdAndUpdate()`, `countDocuments()`, `deleteOne()`, `deleteMany()`, `updateOne()`, `updateMany()`

**3. Zod Validation (v4):**
* Use `.refine()` for URL/Email validation (not `.url()` or `.email()`)
* Use `z.record(keyType, valueType)` for maps (not `z.record(z.any())`)

**4. Type Safety:**
* Explicitly type `reduce` accumulators: `reduce((sum: number, item: any) => ...)`
* Type-assert `await request.json()` results: `const body = (await request.json()) as { ... }`
* Use `Omit<mongoose.Document, "field">` for interface conflicts

**5. Better Auth:**
* Use `better-auth/client/plugins` for client-side plugins (not `better-auth/react/plugins`)

**6. File Extensions:**
* Always use `.tsx` for files containing JSX (never `.ts`)

**7. Next.js 16 Middleware:**
* Always use `proxy.ts`, never `middleware.ts`

**8. IP Address Extraction:**
* Extract IP from headers: `req.headers.get("x-forwarded-for")?.split(",")[0] || req.headers.get("x-real-ip") || "anonymous"`
* Never use `req.ip`

**9. Lazy Initialization:**
* Use lazy initialization for third-party clients requiring environment variables (Stripe, Redis, etc.)
* Use Proxy pattern to avoid build-time failures

**10. BullMQ Queue Types:**
* Use type assertions for Queue constructors and Redis connections: `connection: getRedis() as any`

**11. Mongoose Indexes:**
* Use only one indexing method - either `index: true` OR `Schema.index()`, not both
* `unique: true` automatically creates an index - do NOT add `Schema.index()` for the same field
* Prefer `Schema.index()` over `index: true` for better readability

**12. Stripe API Version:**
* Use API version `"2025-02-24.acacia"` for Stripe

---

## 2. Enterprise SaaS Design System

**Aesthetic**: Calm, professional, information-dense. Comparable to Resend, Stripe, Linear, Notion, and Atlassian.

**Target Quality Bar:** Mature enterprise SaaS. No "demo-like", "marketing-heavy", or "experimental" UI inside the application.

### Typography & Visual Hierarchy

**Page Titles & Headers:**
- **MANDATORY**: Page titles must use `text-lg font-semibold` (never larger)
- **MANDATORY**: Page descriptions must use `text-sm text-foreground` with `mt-0.5` spacing (NOT muted - primary content)
- **MANDATORY**: Section headers within pages must use `text-sm font-semibold`
- **MANDATORY**: Card titles must use `text-sm font-semibold` (never `text-base` or larger)
- **MANDATORY**: Helper text and descriptions must use `text-xs text-foreground` (NOT muted - primary content)
- **FORBIDDEN**: Never use `text-xl`, `text-2xl`, or larger for page titles
- **FORBIDDEN**: Never use `text-base` for descriptions or helper text
- **FORBIDDEN**: Never use marketing-style oversized typography inside the app
- **FORBIDDEN**: Never mute primary content text (descriptions, body text, titles)

**Content Typography:**
- **MANDATORY**: Body text must use `text-sm` (default) or `text-xs` (secondary) with `text-foreground` (NOT muted)
- **MANDATORY**: Value displays (numbers, amounts) must use `text-2xl font-semibold` maximum
- **MANDATORY**: Form labels must use `text-xs text-muted-foreground` (appropriate use case)
- **MANDATORY**: Primary content (descriptions, body text, table content) must use `text-foreground` (NOT muted)

**Typography Legibility Rules:**
- **MANDATORY**: All primary content (body text, titles, headings, descriptions, table content, navigation) must use `text-foreground` for maximum legibility
- **MANDATORY**: Muted text (`text-muted-foreground`) is ONLY allowed for:
  - Form labels
  - Placeholder text
  - Helper/hint text
  - Disabled states
  - Metadata labels (e.g., "Created", "Last Updated")
- **FORBIDDEN**: Never mute primary content text - it must be clearly legible
- **MANDATORY**: Buttons must use `text-foreground` or high-contrast variants for clear visibility

### Spacing & Density

**Page-Level Spacing:**
- **MANDATORY**: Page containers must use `space-y-6` for vertical spacing between major sections
- **MANDATORY**: Page padding must use `py-6` (never `py-8` or larger)
- **MANDATORY**: Card spacing within pages must use `space-y-4` or `space-y-3` (never `space-y-6`)

**Component Spacing:**
- **MANDATORY**: Form fields must use `space-y-2` between label and input
- **MANDATORY**: Button groups must use `gap-2` or `gap-1` (never `gap-4` or larger)
- **MANDATORY**: Navigation items must use `gap-0.5` or `gap-2.5` (tight, professional)
- **MANDATORY**: Card content padding must use `pt-6` (never `p-6` or `p-8`)

**Layout Density:**
- **MANDATORY**: All pages must prioritize information density over whitespace
- **MANDATORY**: Cards must feel compact and scannable, not spacious
- **FORBIDDEN**: Never use excessive padding that creates "floating" content
- **FORBIDDEN**: Never center content arbitrarily (only when explicitly required)

### Cards & Containers

**Card Styling:**
- **MANDATORY**: All cards must use `bg-muted/30` background (subtle, not white)
- **MANDATORY**: Cards must use `CardContent` with `pt-6` (never full padding)
- **MANDATORY**: Card headers (if used) must be compact with `text-sm font-semibold`
- **FORBIDDEN**: Never use `CardHeader`, `CardTitle`, `CardDescription` unless absolutely necessary
- **FORBIDDEN**: Never use white backgrounds for cards (`bg-background` is forbidden)
- **FORBIDDEN**: Never use heavy borders or shadows on cards

```tsx
// ‚ùå WRONG
<Card>
  <CardHeader>
    <CardTitle>Account Balance</CardTitle>
    <CardDescription>Your current balance</CardDescription>
  </CardHeader>
  <CardContent>...</CardContent>
</Card>

// ‚úÖ CORRECT
<Card className="bg-muted/30">
  <CardContent className="pt-6">
    <h3 className="text-sm font-semibold mb-0.5">Account Balance</h3>
    <p className="text-xs text-muted-foreground">Your current balance</p>
    ...
  </CardContent>
</Card>
```

### Navigation & Shell

**Header:**
- **MANDATORY**: Header height must be `h-12` (never `h-14` or larger)
- **MANDATORY**: Header padding must be `px-6` (never `px-4` or `px-8`)
- **MANDATORY**: Logo size must be `h-5 w-5` (never larger)
- **MANDATORY**: Header text must be `text-sm font-medium` (never `font-semibold` or larger)
- **FORBIDDEN**: Never use backdrop blur on header
- **FORBIDDEN**: Never use large logos or branding elements

**Sidebar:**
- **MANDATORY**: Sidebar width must be `w-56` (never `w-64` or larger)
- **MANDATORY**: Navigation items must use `px-2.5 py-2` (compact padding)
- **MANDATORY**: Navigation spacing must use `gap-0.5` (tight, professional)
- **MANDATORY**: Sidebar padding must be `p-3` (never `p-4` or larger)
- **MANDATORY**: Navigation icons must be `h-4 w-4` (never larger)
- **MANDATORY**: User info at bottom must use `h-7 w-7` avatar (never larger)

**Navigation Items:**
- **MANDATORY**: Active navigation state must use `bg-accent text-accent-foreground`
- **MANDATORY**: Inactive state must use `text-muted-foreground hover:bg-accent`
- **MANDATORY**: Navigation text must be `text-sm font-medium`

### Buttons & Interactive Elements

**Button Sizing:**
- **MANDATORY**: Primary action buttons must use `size="sm"` (never default size)
- **MANDATORY**: Secondary buttons must use `size="sm"` with `variant="outline"`
- **MANDATORY**: Icon-only buttons must use `h-8 w-8` (never `h-10 w-10`)
- **FORBIDDEN**: Never use `size="lg"` inside the application (only for marketing pages)

**Button Hierarchy:**
- **MANDATORY**: Primary actions must be visually obvious but not dominant
- **MANDATORY**: Secondary actions must recede visually
- **MANDATORY**: Destructive actions must use `variant="destructive"` explicitly

**Icons:**
- **MANDATORY**: Icons in buttons must be `h-3.5 w-3.5` or `h-4 w-4` (never larger)
- **MANDATORY**: Icons in navigation must be `h-4 w-4`
- **MANDATORY**: Icons in cards must be `h-3.5 w-3.5` or smaller

### Forms & Inputs

**Input Styling:**
- **MANDATORY**: All inputs must use `h-9` height (never `h-10` or default)
- **MANDATORY**: Labels must use `text-xs text-muted-foreground`
- **MANDATORY**: Helper text must use `text-xs text-muted-foreground`
- **MANDATORY**: Form sections must use `space-y-2` or `space-y-3` (never `space-y-4`)

**Form Layout:**
- **MANDATORY**: Forms must be wrapped in `Card` with `bg-muted/30`
- **MANDATORY**: Form submit buttons must use `size="sm"` and be right-aligned
- **MANDATORY**: Form spacing must be compact (`space-y-4` maximum)

### Settings Architecture

**Settings vs Profile Separation:**
- **MANDATORY**: Profile (`/profile`) is user-scoped only (email, auth, MFA, preferences)
- **MANDATORY**: Settings (`/settings`) is tenant-scoped only (members, general, billing, usage)
- **FORBIDDEN**: Never mix user-scoped and tenant-scoped settings on the same page
- **FORBIDDEN**: Never duplicate profile functionality in Settings

**Settings Navigation:**
- **MANDATORY**: Settings must use horizontal tabs (Resend style)
- **MANDATORY**: Tab spacing must use `space-x-6` (never larger)
- **MANDATORY**: Active tab must use `border-foreground text-foreground`
- **MANDATORY**: Inactive tabs must use `text-muted-foreground hover:border-muted-foreground`

### Dashboard vs Analytics Separation

**Dashboard (High-Level):**
- **MANDATORY**: Dashboard must show summary metrics only (no deep analytics)
- **MANDATORY**: Dashboard must prioritize primary CTAs and quick actions
- **MANDATORY**: Dashboard cards must be compact with `bg-muted/30`
- **FORBIDDEN**: Never show dense charts or historical drill-downs on dashboard
- **FORBIDDEN**: Never reuse analytics components on dashboard

**Analytics (Deep Insights):**
- **MANDATORY**: Analytics must be a separate, dedicated area
- **MANDATORY**: Analytics must show detailed metrics, trends, and patterns
- **MANDATORY**: Analytics must use distinct visual patterns from dashboard
- **FORBIDDEN**: Never show dashboard-style summary widgets in analytics

### Normal Mode vs Organization Mode

**Feature Gating:**
- **MANDATORY**: Teams features must be completely hidden in Normal mode
- **MANDATORY**: Team-related UI, messaging, and navigation must not appear in Normal mode
- **MANDATORY**: Delete Account messaging must be conditional (no team references in Normal mode)
- **FORBIDDEN**: Never show "teams" or "organization" terminology in Normal mode UI
- **FORBIDDEN**: Never reference team concepts in Normal mode error messages or empty states

**Mode-Aware UI:**
- **MANDATORY**: All pages must check `tenantState` and adapt UI accordingly
- **MANDATORY**: Navigation must conditionally show organization-only items
- **MANDATORY**: Settings must show appropriate sections based on mode

### Empty States & Loading States

**Empty States:**
- **MANDATORY**: Empty states must be calm and instructional (never loud or marketing-heavy)
- **MANDATORY**: Empty state titles must use `text-2xl font-semibold` maximum
- **MANDATORY**: Empty state descriptions must use `text-sm text-muted-foreground`
- **MANDATORY**: Empty state CTAs must use `size="lg"` (only exception to button sizing rule)
- **FORBIDDEN**: Never use oversized illustrations or marketing-style graphics

**Loading States:**
- **MANDATORY**: Loading skeletons must match final content size and layout
- **MANDATORY**: Loading states must use `Skeleton` component with appropriate sizing
- **MANDATORY**: Loading indicators must be subtle (`text-muted-foreground`)

---

## 3. The "Golden Page" Pattern

*Use this exact structure for all dashboard pages to ensure consistency and reduce re-prompting.*

```tsx
import { Suspense } from "react"
import { Skeleton } from "@/components/ui/skeleton"
import { Button } from "@/components/ui/button"
import { Plus } from "lucide-react"
import { DataList } from "./_components/data-list"

export default function Page() {
  return (
    <div className="space-y-6 py-6">
      {/* 1. Header: Standardized spacing and typography */}
      <div className="flex items-center justify-between">
        <div className="space-y-1">
          <h1 className="text-lg font-semibold">Page Title</h1>
          <p className="text-sm text-foreground mt-0.5">
            Clear, concise description of what this page does.
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Button size="sm">
            <Plus className="mr-2 h-3.5 w-3.5" />
            Action
          </Button>
        </div>
      </div>

      {/* 2. Content: Suspense wrapper with skeleton fallback */}
      <div className="space-y-4">
        <Suspense fallback={<Skeleton className="h-[200px] w-full bg-muted/30" />}>
          {/* Server Component for Data */}
          <DataList />
        </Suspense>
      </div>
    </div>
  )
}
```

**Key Requirements:**
* Use `space-y-6 py-6` for page container
* Use `text-lg font-semibold` for title (never larger)
* Use `text-sm text-foreground` for description with `mt-0.5`
* Always wrap data fetching in `<Suspense>` with Skeleton fallback
* Use Server Components by default (no `'use client'` unless needed)

---

## 4. Micro-Interactions & Polish

*Enhance the design system with subtle, professional interactions.*

1. **Hover States**: 
   * Cards: `hover:scale-[1.02] transition-transform duration-200` (subtle, professional)
   * Buttons: Standard Shadcn hover states (not overly playful)
   * Maintain enterprise aesthetic

2. **Loading States**: 
   * **MANDATORY**: Always use Skeleton loaders (`<Skeleton />` from Shadcn UI)
   * Match skeleton layout to final content structure
   * Use appropriate sizing and spacing

3. **Motion**: 
   * Fade in: `initial={{ opacity: 0 }} animate={{ opacity: 1 }}` (Framer Motion)
   * Spring physics: `{ stiffness: 400, damping: 30 }`
   * Keep animations subtle and professional
   * **Rule**: Animations communicate state, not decorate

4. **Accessibility**: 
   * All inputs must have labels (use Shadcn `<Label>` component)
   * All images must have alt text
   * Interactive elements must be keyboard navigable
   * Focus states: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2`

---

## 5. üõë Hard Stops (Auto-Reject Code)

**‚ö†Ô∏è CRITICAL: If any of these patterns are detected, the code MUST be rejected and regenerated.**

1. **No `useEffect` for data fetching**: Use Server Components + Suspense. `useEffect` is only for client-side side effects.

2. **No `bg-white` or `bg-black`**: Use `bg-card` or `bg-muted/30`. Never use arbitrary white/black backgrounds.

3. **No `text-white` on body text**: Use `text-foreground` or appropriate semantic colors for body text. Pure white is only for headings when appropriate.

4. **No default buttons**: Always specify `size="sm"` explicitly. Never omit the `size` prop.

5. **No arbitrary colors**: Use design system tokens. Never use `bg-blue-500`, `text-red-400`, or Tailwind default colors not in the design system.

6. **No `text-xl` or larger for page titles**: Page titles must be `text-lg font-semibold` (never larger).

7. **No `h-10` inputs**: Always use `h-9` for all inputs. Never use default height or `h-10`.

8. **No manual memoization without profiling**: Do not use `useMemo`, `useCallback`, or `memo` unless profiling proves it necessary. React Compiler handles this.

9. **No `CardHeader`/`CardTitle`/`CardDescription`**: Use inline structure with `CardContent` and proper typography unless absolutely necessary.

10. **No mixing user-scoped and tenant-scoped settings**: Profile and Settings must remain separate.

11. **No team concepts in Normal mode**: Teams/organization terminology must be hidden in Normal mode.

12. **No Mongoose operations without `(Model as any)`**: Always cast models to `any` for method calls.

---

## 6. Implementation Checklist

*Before outputting code, verify:*

**Design System:**
- [ ] Page title uses `text-lg font-semibold` (not larger)
- [ ] Page description uses `text-sm text-foreground` with `mt-0.5`
- [ ] All cards use `bg-muted/30` background
- [ ] All buttons use `size="sm"` explicitly (except empty state CTAs)
- [ ] All inputs use `h-9` height (never `h-10` or default)
- [ ] All labels use `text-xs text-muted-foreground`
- [ ] Spacing is compact (`space-y-6` page-level, `space-y-4` section-level)
- [ ] Typography is restrained (no oversized fonts)
- [ ] No visual clutter or excessive emphasis
- [ ] Matches Resend/Stripe/Linear aesthetic (calm, professional, dense)
- [ ] Tenant mode is properly handled (Normal vs Organization)
- [ ] Settings vs Profile separation is maintained

**Code Quality:**
- [ ] Data fetching in Server Component with Suspense (no `useEffect`)
- [ ] No manual memoization (unless profiled)
- [ ] Mongoose models use `(Model as any).method()` pattern
- [ ] Catch blocks type errors as `unknown`
- [ ] Third-party clients use lazy initialization
- [ ] All `request.json()` and `response.json()` have type assertions
- [ ] Zod validations use v4-compatible syntax (`.refine()` for URLs/emails, `z.record(keyType, valueType)`)
- [ ] No JSX in `.ts` files (use `.tsx`)
- [ ] Better Auth imports use correct paths (`better-auth/client/plugins`)
- [ ] IP addresses extracted from headers, not `req.ip`
- [ ] Reduce callbacks have explicit type annotations
- [ ] No duplicate Mongoose index definitions
- [ ] BullMQ connections use type assertions

**States & UX:**
- [ ] Skeleton loaders for loading states (never raw content loading)
- [ ] Empty states with appropriate CTAs
- [ ] Error states with proper styling
- [ ] Success feedback (toast or inline)

**Accessibility:**
- [ ] All inputs have labels
- [ ] All images have alt text
- [ ] Interactive elements are keyboard navigable
- [ ] Focus states are properly styled
- [ ] Color contrast meets WCAG AA standards

---

## 7. Sentry Integration

**Exception Catching:**
Use `Sentry.captureException(error)` to capture an exception and log the error in Sentry.
Use this in try catch blocks or areas where exceptions are expected.

**Tracing:**
Spans should be created for meaningful actions within an application like button clicks, API calls, and function calls.
Use the `Sentry.startSpan` function to create a span.
Child spans can exist within a parent span.

**Custom Span instrumentation in component actions:**
```typescript
import * as Sentry from "@sentry/nextjs"

function TestComponent() {
  const handleTestButtonClick = () => {
    Sentry.startSpan(
      {
        op: "ui.click",
        name: "Test Button Click",
      },
      (span) => {
        const value = "some config"
        const metric = "some metric"
        span.setAttribute("config", value)
        span.setAttribute("metric", metric)
        doSomething()
      },
    )
  }
  return (
    <button type="button" onClick={handleTestButtonClick}>
      Test Sentry
    </button>
  )
}
```

**Custom span instrumentation in API calls:**
```typescript
import * as Sentry from "@sentry/nextjs"

async function fetchUserData(userId: string) {
  return Sentry.startSpan(
    {
      op: "http.client",
      name: `GET /api/users/${userId}`,
    },
    async () => {
      const response = await fetch(`/api/users/${userId}`)
      const data = await response.json()
      return data
    },
  )
}
```

**Logs:**
Where logs are used, ensure Sentry is imported using `import * as Sentry from "@sentry/nextjs"`.
Enable logging in Sentry using `Sentry.init({ enableLogs: true })`.
Reference the logger using `Sentry.logger` (not destructured).

**Configuration:**
In NextJS with `@sentry/nextjs`, the standard setup uses:
- `sentry.client.config.ts` for client-side initialization
- `sentry.server.config.ts` for server-side initialization
- `sentry.edge.config.ts` for edge runtime initialization (optional)
- `sentry.config.ts` is used by the Sentry webpack plugin for build-time configuration

Initialization does not need to be repeated in other files, it only needs to happen in the config files mentioned above.

**Logger Examples:**
```typescript
import * as Sentry from "@sentry/nextjs"

// Always use Sentry.logger, not a destructured logger
Sentry.logger.trace("Starting database connection", { database: "users" })
Sentry.logger.debug(Sentry.logger.fmt`Cache miss for user: ${userId}`)
Sentry.logger.info("Updated profile", { profileId: 345 })
Sentry.logger.warn("Rate limit reached for endpoint", {
  endpoint: "/api/results/",
  isEnterprise: false,
})
Sentry.logger.error("Failed to process payment", {
  orderId: "order_123",
  amount: 99.99,
})
Sentry.logger.fatal("Database connection pool exhausted", {
  database: "users",
  activeConnections: 100,
})
```

---

**Priority Order for References:**
1. **RULESETS.md** - Mandatory code patterns (prevents build errors)
2. **This file** - Production rules and patterns
3. **Shadcn UI Documentation** - Component implementation examples

**When guidelines conflict, prioritize RULESETS.md for code patterns and this file for design decisions.**
